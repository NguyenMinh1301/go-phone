<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="go_phone.security.mapper.UserMapper">

    <resultMap id="UserResult" type="go_phone.security.entity.User">
        <id property="userId"           column="user_id"/>
        <result property="username"     column="username"/>
        <result property="email"        column="email"/>
        <result property="password"     column="password"/>
        <result property="fullName"     column="full_name"/>
        <result property="phone"        column="phone"/>
        <result property="address"      column="address"/>
        <result property="createdAt"    column="created_at"/>
        <result property="createdBy"    column="created_by"/>
        <result property="updatedAt"    column="updated_at"/>
        <result property="updatedBy"    column="updated_by"/>
        <result property="isActive"     column="is_active"/>
        <result property="isDeleted"    column="is_deleted"/>
    </resultMap>

    <select id="findByUsername" parameterType="string" resultMap="UserResult">
        SELECT
        user_id,
        username, email, password, full_name, phone, address,
        created_at, created_by, updated_at, updated_by,
        is_active, is_deleted
        FROM `user`
        WHERE username = #{username} AND is_deleted = 0
        LIMIT 1
    </select>

    <select id="findByEmail" parameterType="string" resultMap="UserResult">
        SELECT
        user_id,
        username, email, password, full_name, phone, address,
        created_at, created_by, updated_at, updated_by,
        is_active, is_deleted
        FROM `user`
        WHERE email = #{email} AND is_deleted = 0
        LIMIT 1
    </select>

    <select id="existsByUsername" parameterType="string" resultType="int">
        SELECT COUNT(1)
        FROM `user`
        WHERE username = #{username} AND is_deleted = 0
    </select>

    <select id="existsByEmail" parameterType="string" resultType="int">
        SELECT COUNT(1)
        FROM `user`
        WHERE email = #{email} AND is_deleted = 0
    </select>

    <insert id="insert" parameterType="go_phone.security.entity.User" useGeneratedKeys="true" keyProperty="userId" keyColumn="user_id">
        INSERT INTO `user` (
        username
        , email
        , password
        , full_name
        , phone
        , address
        , created_at
        , created_by
        , is_active
        , is_deleted
        )
        VALUES(
        #{username}
        , #{email}
        , #{password}
        , #{fullName}
        , #{phone}
        , #{address}
        , NOW()
        , #{createdBy}
        , #{isActive}
        , #{isDeleted})
    </insert>

    <update id="updatePasswordById">
        UPDATE `user` SET password =
        #{password}
        , updated_at = NOW()
        , updated_by = 'system'
        WHERE user_id = #{userId}
    </update>

</mapper>
