<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="go_phone.feature.payment.mapper.PaymentAttemptMapper">

    <resultMap id="AttemptMap" type="go_phone.feature.payment.entity.PaymentAttempt">
        <id column="attempt_id"                 property="attemptId"/>
        <result column="order_id"               property="orderId"/>
        <result column="gateway"                property="gateway"/>
        <result column="gateway_payment_id"     property="gatewayPaymentId"/>
        <result column="checkout_url"           property="checkoutUrl"/>
        <result column="status"                 property="status"/>
        <result column="amount"                 property="amount"/>
        <result column="currency"               property="currency"/>
        <result column="idempotency_key"        property="idempotencyKey"/>
        <result column="raw_payload"            property="rawPayload"/>
        <result column="created_at"             property="createdAt"/>
        <result column="updated_at"             property="updatedAt"/>
    </resultMap>

    <insert id="insert" parameterType="go_phone.feature.payment.entity.PaymentAttempt" useGeneratedKeys="true" keyProperty="attemptId">
        INSERT INTO payment_attempts (
        order_id
        , gateway
        , gateway_payment_id
        , checkout_url
        , status
        , amount
        , currency
        , idempotency_key
        , raw_payload
        , created_at
        ) VALUES (
        #{orderId}
        , #{gateway}
        , #{gatewayPaymentId}
        , #{checkoutUrl}
        , #{status}
        , #{amount}
        , #{currency}
        , #{idempotencyKey}
        , #{rawPayload}
        , NOW()
        )
    </insert>

    <update id="updateOnGateway">
        UPDATE payment_attempts
        SET gateway_payment_id = #{gatewayPaymentId},
        checkout_url = #{checkoutUrl},
        status = #{status},
        updated_at = NOW()
        WHERE order_id = #{orderId}
        LIMIT 1
    </update>

    <update id="markStatus">
        UPDATE payment_attempts SET status = #{status}, updated_at = NOW()
        WHERE order_id = #{orderId} LIMIT 1
    </update>

    <select id="findByOrderId" parameterType="long" resultMap="AttemptMap">
        SELECT
        order_id
        , gateway
        , gateway_payment_id
        , checkout_url
        , status
        , amount
        , currency
        , idempotency_key
        , raw_payload
        , created_at
        , update_at
        FROM payment_attempts
        WHERE order_id = #{orderId} LIMIT 1
    </select>

</mapper>
