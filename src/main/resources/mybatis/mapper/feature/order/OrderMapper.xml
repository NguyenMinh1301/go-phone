<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="go_phone.feature.order.mapper.OrderMapper">

    <resultMap id="OrderMap" type="go_phone.feature.order.entity.Order">
        <id    column="order_id"      property="orderId"/>
        <result column="order_code"   property="orderCode"/>
        <result column="user_id"      property="userId"/>
        <result column="status"       property="status"/>
        <result column="amount_items" property="amountItems"/>
        <result column="discount_amount" property="discountAmount"/>
        <result column="shipping_fee" property="shippingFee"/>
        <result column="tax_amount"   property="taxAmount"/>
        <result column="grand_total"  property="grandTotal"/>
        <result column="currency"     property="currency"/>
        <result column="customer_name"  property="customerName"/>
        <result column="customer_phone" property="customerPhone"/>
        <result column="customer_email" property="customerEmail"/>
        <result column="shipping_address_json" property="shippingAddressJson"/>
        <result column="pay_gateway" property="payGateway"/>
        <result column="pay_ref"     property="payRef"/>
        <result column="created_at"  property="createdAt"/>
        <result column="created_by"  property="createdBy"/>
        <result column="updated_at"  property="updatedAt"/>
        <result column="updated_by"  property="updatedBy"/>
    </resultMap>

    <insert id="insert" parameterType="go_phone.feature.order.entity.Order" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO orders (
        order_code
        , user_id
        , status
        , amount_items
        , discount_amount
        , shipping_fee
        , tax_amount
        , grand_total
        , currency
        , customer_name
        , customer_phone
        , customer_email
        , shipping_address_json
        , pay_gateway
        , pay_ref
        , created_at
        , created_by
        , is_deleted
        ) VALUES (
        #{orderCode}
        , #{userId}
        , #{status}
        , #{amountItems}
        , #{discountAmount}
        , #{shippingFee}
        , #{taxAmount}
        , #{grandTotal}
        , #{currency}
        , #{customerName}
        , #{customerPhone}
        , #{customerEmail}
        , #{shippingAddressJson}
        , #{payGateway}
        , #{payRef}
        , NOW()
        , #{createdBy}
        , 0
        )
    </insert>

    <select id="findByOrderCode" parameterType="long" resultMap="OrderMap">
        SELECT * FROM orders
        WHERE order_code = #{orderCode}
        AND is_deleted = 0 LIMIT 1
    </select>

    <update id="updateStatusByOrderCode">
        UPDATE orders
        SET status = #{status},
        pay_ref = #{payRef},
        updated_at = NOW()
        WHERE order_code = #{orderCode}
        AND is_deleted = 0
    </update>

    <select id="existsByOrderCode" parameterType="long" resultType="boolean">
        SELECT EXISTS (
        SELECT 1 FROM orders WHERE order_code = #{orderCode}
        AND is_deleted = 0
        )
    </select>

</mapper>
